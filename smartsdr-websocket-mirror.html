<!DOCTYPE html>
<html lang="en">
<head>
    <title>smartsdr-websocket-mirror</title>

    <script type="text/javascript">


        const reader = new FileReader();
        const decoder = new TextDecoder()

        window.onload = function () {

            var canvas = document.getElementById('canvas0x40000000');
            var ctx = canvas.getContext('2d');

            var conn;


            function appendLog(item) {
                var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
                log.appendChild(item);
                if (doScroll) {
                    log.scrollTop = log.scrollHeight - log.clientHeight;
                }
            }

            function handleFftPackage(buffer) {

                var values = new Uint16Array(buffer.slice(10))
                var panadapterIdHexString = "0x" + decoder.decode(new Uint16Array(buffer.slice(2, 10))).trim()

                if (panadapterIdHexString != "0x40000000") {
                    return;
                }

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.beginPath();
                ctx.moveTo(0, values[0]);
                ctx.beginPath();
                ctx.moveTo(0, values[0]);
                var n = 0;
                for (n = 0; n < values.length; n++) {
                    ctx.lineTo((n), values[n]);
                }
                ctx.moveTo(values.length, values[values.length]);
                ctx.strokeStyle = '#0800ff';
                ctx.stroke();
            }

            function handlePanadapterMessage(buffer) {
                var jsonPanadapter = JSON.parse(decoder.decode(new Uint16Array(buffer.slice(2))).trim())

                if (canvas.width != jsonPanadapter["0x40000000"].XPixels) {
                    canvas.width = jsonPanadapter["0x40000000"].XPixels
                    console.info("canvas resize")
                }

                if (canvas.height != jsonPanadapter["0x40000000"].YPixels) {
                    canvas.height = jsonPanadapter["0x40000000"].YPixels
                    console.info("canvas resize")
                }

               // console.info(jsonPanadapter)
            }

            if (window["WebSocket"]) {
                conn = new WebSocket("ws://" + document.location.host + "/ws");
                conn.onclose = function (evt) {
                    var item = document.createElement("div");
                    item.innerHTML = "<b>Connection closed.</b>";
                    appendLog(item);
                };
                conn.onmessage = function (evt) {

                    var reader = new FileReader();
                    reader.readAsArrayBuffer(evt.data);
                    reader.onloadend = () => {
                        buffer = reader.result
                        var prefix = decoder.decode(new Uint16Array(buffer.slice(0, 2))).trim()
                        switch (prefix) {
                            case "F":
                                handleFftPackage(buffer)
                                break;
                            case "P":
                                handlePanadapterMessage(buffer)
                                break;
                        }
                    }
                };
            } else {
                var item = document.createElement("div");
                item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                appendLog(item);
            }
        };
    </script>
</head>
<body>
<p>

    Panadapter 0x40000000
<div style="border: 2px black;">
    <canvas id="canvas0x40000000" width=500 height=3500"></canvas>
</div>
</p>
</body>
</html>